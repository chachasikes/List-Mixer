<?php
// $Id$

/*
 *******************************************************************************
 * @file listmixer_storage_nodes.module
 * Main module file for List Mixer Node Storage module
 *******************************************************************************
 */
 
include('includes/listmixer_storage_nodes.inc'); 
 
/**
 *  listmixer_storage_register hook implementation
 *  Return this type to the list of storage methods available to the preset selector.
 */
 
function listmixer_storage_nodes_listmixer_storage_register() {
  return array(
    array(
    'name' => 'Nodes', 
    'module' => 'listmixer_storage_nodes',
    'weight' => '-10',
    ),
  );
}

function listmixer_storage_nodes_load_interaction_form(&$form, &$form_state, $preset = array()) {
  $results = db_query("SELECT * FROM {listmixer_storage_nodes} WHERE preset_id = %d", $preset['preset_id']);
  while ($row = db_fetch_array($results)) {
    $interaction = $row;
  }

  $form = array();
  
  $form['interaction_id'] = array(
    '#type' => 'value',
    '#value' => $interaction['interaction_id'],
  );
  $form['preset_id'] = array(
    '#type' => 'value',
    '#value' => $preset['preset_id'],
  );

  $form['interaction_target_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Interaction Target ID'),
    '#default_value' => $interaction['interaction_target_id'],
    '#description' => t('The name of a views block id to be used as a container for storing list data.'),
    '#weight' => 1,
  );
  $all_nodetypes = node_get_types();
  $all_nodetype_options = array();
  foreach ($all_nodetypes as $item) {
    $all_nodetype_options[$item->type] = $item->name;
  }
  $form['interaction_source_content_types'] = array(
      '#type' => 'select',
      '#title' => t('Content types'),
      '#description' => t('Select which content types will be allowed to be added to the list content type.'),
      '#options' => $all_nodetype_options,
      '#default_value' => $interaction['interaction_source_content_types'],
      '#weight' => 2,
  );
  $form['interaction_restrictions'] = array(
      '#type' => 'textarea',
      '#title' => t('Restrict Markup'),
      '#description' => '<p>' .t('Provide a newline separated list of markup targets to exclude. Enter in jQuery compatible format, ex div.view-favorites, form#edit-image.
                         This will restrict interactions on a page to a container or condition.') . '</p>',
      '#default_value' => $interaction['interaction_restrictions'],
      '#weight' => 3,
  );
  $form['interaction_inclusions'] = array(
      '#type' => 'textarea',
      '#title' => t('Include Markup'),
      '#description' => '<p>' .t('Provide a newline separated list of markup targets to exclude. Enter in jQuery compatible format, ex div.view-favorites, form#edit-image.
                        This will make interaction available to containers and conditions, especially if they were partly overridden by the restrictions.') . '</p>',
      '#default_value' => $interaction['interaction_inclusions'],
      '#weight' => 4,
  );
  return $form;
}


/**
 * Save an listmixer preset.
 *
 * @param preset
 *   an listmixer preset array.
 * @return
 *   a preset array.  In the case of a new preset, 'preset_id' will be populated.
 */
function listmixer_storage_nodes_listmixer_storage_save($form, &$form_state) {
  $form_store = $form_state['values']['interaction'][0];
  $form_store['preset_id'] = $form_state['values']['preset_id'];
  // If an id already exists
  if (!empty($form['interaction'][0]['interaction_id']['#value'])) {
    drupal_write_record('listmixer_storage_nodes', $form_store, array('preset_id'));
  }
  else {
    drupal_write_record('listmixer_storage_nodes', $form_store);
  }
  return $behavior;
}

/**
 * Delete interaction preset.
 */
function listmixer_storage_nodes_listmixer_storage_delete($preset) {
 db_query("DELETE FROM {listmixer_storage_nodes} WHERE preset_id = '%d'", $preset['preset_id']);
 return TRUE;
}

 