// $Id$
Drupal.behaviors.listmixer = function() {
  // Read through each preset
  $.each(Drupal.settings.listmixer, function(){
    // If page contains a target block
    if(this.preset_method == 'listmixer_storage_nodes') {
      // Node target finding mechanism #1, The First
      // The view must contain .views-field-nid (generated by adding a field)
      // @TODO add a setting so user can specify the class/field that contains the node data. then they can put it whereever. let it be a full jQuery command.

      // Find the contents of an nid field, store it, and then hide it.
      $('#' + this.interactions.interactions_target_id).find('div.views-field-nid span.field-content').each(function(){
        this.target_nid = $(this).html();
      }).hide();      
      
      
      
      // @TODO: Look up with behaviors to apply to the page
      
      
      // @TODO: Look up which behaviors to load/apply to the target
      
      // @TODO: So the idea will be to build a library of buttons and things, and then load them based on the behavior settings.
      
      this.target_form_class = 'class="listmixer-target-form"';   
      this.target_form_id = 'listmixer-target-'+ this.preset_name;
      this.target_form = '<form id="' + this.target_form_id + '" ' + this.target_form_class + '></form>';
      this.interact = '<input></input>';
      this.submit = '<button>Save</button>';
      
      Drupal.behaviors.listmixer.push(this);
      
     // Add callbacks
      
      $('#' + this.interactions.interactions_target_id).append(this.target_form);

      $('#' + this.target_form_id).append(this.interact);
      
      // Add interact button (load js from interact button function)
      $('#' + this.target_form_id).append(this.submit);
      
      // @TODO: connect submit function to push callback and data
      
      // @TODO: add field spec to settings for behaviors
      
      
      
      // options:
      // if view content contains 'nid'...
      // http://11heavens.com/theming-Drupal-6-from-the-module-layer
      
      // semantic view
      // make user add markup with node id -- this ensure they have ultimate control * (definite option)
      // theme preprocess function all nodes add class listmixer-node-#nid
    }
  });
}

Drupal.behaviors.listmixer.push = function(preset) {    
  var preset = preset;
  var preset_id = preset.preset_id;

  // Load push name from preset settings.
  var push_name = preset.behaviors.push.behavior_name;
  // Load data from settings array contained in each behavior.
  var push_callback = Drupal.settings.basePath + preset.behaviors.push.settings.behavior_callback;
  
  // @TODO a callback is called. a menu item figures out who the callback is for, looks up the registry and calls the appropriate function.
  var data_label = 'data_' + push_name;
  //$(this).attr('drag_list_value')
  //var data = {data_label : 'test data content'};
  var data = { name: "John", time: "2pm" };
  // Load javascript include for this behavior.
  $.getScript(preset.behaviors.push.settings.behavior_javascript);
  // Ajax call to callback for this behavior.
  // @TODO currently this runs automatically, make push happen after submit behavior is activated.

  $.post(push_callback, data,  Drupal.behaviors.listmixer.redirect(preset, data));

  // Prevent entire page from reloading 
  return false;         
}


Drupal.behaviors.listmixer.redirect = function(preset, data) {
  var preset = preset;
  var data = data;  
  return false;  
}